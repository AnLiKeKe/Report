<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>回收版使用统计报表</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #1890ff;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: normal;
        }
        
        .controls {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .controls label {
            font-weight: bold;
            color: #333;
        }
        
        select, button, input {
            padding: 8px 15px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #1890ff;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        button:hover:not(:disabled) {
            background: #40a9ff;
        }

        .pagination {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .page-btn {
            padding: 6px 12px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            background: #40a9ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .page-btn:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }

        .page-info {
            color: #666;
            font-size: 14px;
        }

        .total-records {
            color: #666;
            font-size: 14px;
            margin-left: 15px;
            padding-left: 15px;
            border-left: 1px solid #e8e8e8;
        }
        
        button:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        
        .content {
            padding: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #ff4d4f;
            background: #fff2f0;
            border: 1px solid #ffccc7;
            border-radius: 4px;
            margin: 20px;
        }
        
        .table-section {
            background: white;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 2000px;
        }
        
        table {
            table-layout: auto;
        }

        th, td {
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #e8e8e8;
            font-size: 14px;
            white-space: nowrap;
        }
        
        th {
            background: #fafafa;
            font-weight: bold;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .chart-section {
            background: white;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #1890ff;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .export-section {
            margin-bottom: 20px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>回收版使用统计报表</h1>
            </div>
            
            <!-- 查询条件 -->
            <div class="controls">
                <label>客户：</label>
                <select v-model="filters.customer">
                    <option value="">全部客户</option>
                    <option v-for="customer in customers" :key="customer" :value="customer">{{ customer }}</option>
                </select>
                
                <label>主材供应商：</label>
                <select v-model="filters.supplier">
                    <option value="">全部供应商</option>
                    <option v-for="supplier in suppliers" :key="supplier" :value="supplier">{{ supplier }}</option>
                </select>
                
                <label>订单类型：</label>
                <select v-model="filters.orderType">
                    <option value="">全部类型</option>
                    <option v-for="type in orderTypes" :key="type" :value="type">{{ type }}</option>
                </select>
                

                
                <button @click="loadReport" :disabled="loading">
                    {{ loading ? '加载中...' : '查询' }}
                </button>
                
                <button @click="exportData" :disabled="!reportData">
                    导出Excel
                </button>
            </div>
            
            <div class="content">
                <!-- 加载状态 -->
                <div v-if="loading && !reportData" class="loading">
                    数据加载中...
                </div>
                

                

                
                <!-- 数据表格 -->
                <div v-if="reportData" class="table-section">
                    <h2>详细数据</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>客户名称</th>
                                <th>流程单号</th>
                                <th>Model号</th>
                                <th>制作设备</th>
                                <th>CD</th>
                                <th>图层</th>
                                <th>锁单时间</th>
                                <th>主材批号</th>
                                <th>主材供应商</th>
                                <th>订单类型</th>
                                <th>尺寸</th>
                                <th>黑缺陷</th>
                                <th>白缺陷</th>
                                <th>修补时间/h</th>
                                <th>判定类别</th>
                                <th>玻璃来源</th>
                                <th>抛光厂家</th>
                                <th>镀铬厂家</th>
                                <th>涂胶厂家</th>
                                <th>回收情况</th>
                                <th>再处理方案</th>
                                <th>回收批次</th>
                                <th>厂别</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(item, index) in paginatedData" :key="index">
                                <td>{{ item.customer }}</td>
                                <td>{{ item.processNumber }}</td>
                                <td>{{ item.model }}</td>
                                <td>{{ item.equipment }}</td>
                                <td>{{ item.cd }}</td>
                                <td>{{ item.layer }}</td>
                                <td>{{ item.lockTime }}</td>
                                <td>{{ item.batchNumber }}</td>
                                <td>{{ item.supplier }}</td>
                                <td>{{ item.orderType }}</td>
                                <td>{{ item.size }}</td>
                                <td>{{ item.blackDefect }}</td>
                                <td>{{ item.whiteDefect }}</td>
                                <td>{{ item.repairTime }}</td>
                                <td>{{ item.judgeType }}</td>
                                <td>{{ item.glassSource }}</td>
                                <td>{{ item.polishSupplier }}</td>
                                <td>{{ item.chromeSupplier }}</td>
                                <td>{{ item.glueSupplier }}</td>
                                <td>{{ item.recycleStatus }}</td>
                                <td>{{ item.reprocessPlan }}</td>
                                <td>{{ item.recycleBatch }}</td>
                                <td>{{ item.factory }}</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- 分页控件 -->
                     <div class="pagination" style="margin: 20px 0; display: flex; justify-content: center; align-items: center; gap: 10px;">
                         <button @click="currentPage--" :disabled="currentPage === 1" class="page-btn">上一页</button>
                         <div class="page-info">
                             第 {{ currentPage }} / {{ totalPages }} 页
                         </div>
                         <button @click="currentPage++" :disabled="currentPage === totalPages" class="page-btn">下一页</button>
                         <div class="total-records">
                             共 {{ filteredData.length }} 条记录
                         </div>
                         <label style="margin-left: 15px;">每页显示:</label>
                         <select v-model="pageSize" @change="currentPage = 1" style="width: auto;">
                             <option value="10">10条</option>
                             <option value="20">20条</option>
                             <option value="50">50条</option>
                             <option value="100">100条</option>
                         </select>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    filters: {
                        customer: '',
                        supplier: '',
                        orderType: '',
                        year: ''
                    },
                    customers: [],
                    suppliers: [],
                    orderTypes: [],
                    availableYears: [2024, 2023, 2022, 2021],
                    reportData: null,
                    loading: false,
                    error: null,
                    currentPage: 1,
                    pageSize: 10
                }
            },
            
            computed: {
                filteredData() {
                    if (!this.reportData) return [];
                    
                    return this.reportData.filter(item => {
                        return (!this.filters.customer || item.customer === this.filters.customer) &&
                               (!this.filters.supplier || item.supplier === this.filters.supplier) &&
                               (!this.filters.orderType || item.orderType === this.filters.orderType) &&
                               (!this.filters.year || item.year === this.filters.year);
                    });
                },
                
                paginatedData() {
                    const startIndex = (this.currentPage - 1) * this.pageSize;
                    return this.filteredData.slice(startIndex, startIndex + this.pageSize);
                },
                
                totalPages() {
                    return Math.ceil(this.filteredData.length / this.pageSize);
                },
                
                totalRecords() {
                    return this.filteredData.length;
                },
                
                totalBlackDefects() {
                    return this.filteredData.reduce((sum, item) => sum + item.blackDefect, 0);
                },
                
                totalWhiteDefects() {
                    return this.filteredData.reduce((sum, item) => sum + item.whiteDefect, 0);
                },
                
                avgRepairTime() {
                    if (this.filteredData.length === 0) return 0;
                    const total = this.filteredData.reduce((sum, item) => sum + item.repairTime, 0);
                    return (total / this.filteredData.length).toFixed(2);
                }
            },
            
            methods: {
                async loadReport() {
                    this.loading = true;
                    this.error = null;
                    this.reportData = null;
                    
                    try {
                        const params = new URLSearchParams();
                        if (this.filters.customer) params.append('customer', this.filters.customer);
                        if (this.filters.supplier) params.append('supplier', this.filters.supplier);
                        if (this.filters.orderType) params.append('orderType', this.filters.orderType);
                        if (this.filters.year) params.append('year', this.filters.year);
                        
                        const url = `/api/recycling/data?${params}`;
                        console.log(`Fetching recycling data from: ${url}`);
                        
                        const response = await fetch(url);
                        console.log('API Response status:', response.status);
                        console.log('API Response headers:', response.headers);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`HTTP error! status: ${response.status}, response: ${errorText}`);
                            throw new Error(`服务器返回错误 (${response.status}): ${errorText.substring(0, 100)}`);
                        }
                        
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            const text = await response.text();
                            console.error('Invalid content type. Expected JSON, got:', text);
                            throw new Error('服务器返回格式错误，无法解析数据');
                        }
                        
                        const result = await response.json();
                        console.log('API Response data length:', JSON.stringify(result).length);
                        
                        if (result.error) {
                            console.error('API returned error:', result.error);
                            throw new Error(result.error);
                        }
                        
                        if (!result.data || !Array.isArray(result.data)) {
                            console.error('Invalid data format:', result);
                            throw new Error('报表数据格式错误，无法显示');
                        }
                        
                        this.reportData = result.data;
                        // 从查询结果中提取唯一值用于过滤器
                        this.customers = [...new Set(result.data.map(item => item.customer))].sort();
                        this.suppliers = [...new Set(result.data.map(item => item.supplier))].sort();
                        this.orderTypes = [...new Set(result.data.map(item => item.orderType))].sort();
                        console.log('Recycling report data loaded successfully');
                    } catch (error) {
                        console.error('Error loading recycling report:', error);
                        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                            this.error = '网络请求失败，请检查服务器连接或刷新页面';
                        } else if (error.message.includes('Failed to parse JSON')) {
                            this.error = '数据解析错误，服务器返回无效JSON格式';
                        } else {
                            this.error = '获取报表数据失败: ' + error.message;
                        }
                        this.reportData = [];
                    } finally {
                        this.loading = false;
                    }
                },
                
                async generateMockData() {
                    // 作为后备的模拟数据生成
                    const customers = ['客户A', '客户B', '客户C', '客户D', '客户E'];
                    const suppliers = ['供应商1', '供应商2', '供应商3', '供应商4', '供应商5'];
                    const orderTypes = ['标准订单', '加急订单', '特殊订单', '批量订单'];
                    const equipmentList = ['设备A', '设备B', '设备C', '设备D', '设备E'];
                    const factories = ['工厂1', '工厂2', '工厂3', '工厂4', '工厂5'];
                    
                    const data = [];
                    
                    for (let i = 0; i < 50; i++) {
                        data.push({
                            customer: customers[Math.floor(Math.random() * customers.length)],
                            processNumber: `PR${String(i + 1).padStart(6, '0')}`,
                            model: `MOD${String(Math.floor(Math.random() * 1000)).padStart(4, '0')}`,
                            equipment: equipmentList[Math.floor(Math.random() * equipmentList.length)],
                            cd: (Math.random() * 100).toFixed(1),
                            layer: `L${Math.floor(Math.random() * 5) + 1}`,
                            lockTime: this.generateRandomDate(),
                            batchNumber: `BN${String(Math.floor(Math.random() * 10000)).padStart(5, '0')}`,
                            supplier: suppliers[Math.floor(Math.random() * suppliers.length)],
                            orderType: orderTypes[Math.floor(Math.random() * orderTypes.length)],
                            size: `${Math.floor(Math.random() * 100 + 50)}x${Math.floor(Math.random() * 100 + 50)}`,
                            blackDefect: Math.floor(Math.random() * 20),
                            whiteDefect: Math.floor(Math.random() * 15),
                            repairTime: (Math.random() * 5).toFixed(1),
                            judgeType: ['合格', '不合格', '待检'][Math.floor(Math.random() * 3)],
                            glassSource: ['供应商1', '供应商2', '自产'][Math.floor(Math.random() * 3)],
                            polishSupplier: ['抛光厂A', '抛光厂B', '抛光厂C'][Math.floor(Math.random() * 3)],
                            chromeSupplier: ['镀铬厂X', '镀铬厂Y'][Math.floor(Math.random() * 2)],
                            glueSupplier: ['涂胶厂1', '涂胶厂2', '涂胶厂3'][Math.floor(Math.random() * 3)],
                            recycleStatus: ['已回收', '未回收', '部分回收'][Math.floor(Math.random() * 3)],
                            reprocessPlan: ['重新加工', '报废处理', '降级使用'][Math.floor(Math.random() * 3)],
                            recycleBatch: `RB${String(Math.floor(Math.random() * 1000)).padStart(4, '0')}`,
                            factory: factories[Math.floor(Math.random() * factories.length)],
                            year: this.filters.year || new Date().getFullYear()
                        });
                    }
                    
                    this.reportData = data;
                },
                
                generateRandomDate() {
                    const start = new Date(2024, 0, 1);
                    const end = new Date();
                    const randomDate = new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
                    return randomDate.toLocaleDateString('zh-CN');
                },
                
                exportData() {
                    if (!this.reportData) return;
                    
                    // 准备工作表数据
                    const headers = [
                        '客户名称', '流程单号', 'Model号', '制作设备', 'CD', '图层',
                        '锁单时间', '主材批号', '主材供应商', '订单类型', '尺寸',
                        '黑缺陷', '白缺陷', '修补时间/h', '判定类别', '玻璃来源',
                        '抛光厂家', '镀铬厂家', '涂胶厂家', '回收情况', '再处理方案',
                        '回收批次', '厂别'
                    ];
                    
                    const dataRows = this.filteredData.map(item => [
                        item.customer, item.processNumber, item.model, item.equipment, item.cd, item.layer,
                        item.lockTime, item.batchNumber, item.supplier, item.orderType, item.size,
                        item.blackDefect, item.whiteDefect, item.repairTime, item.judgeType, item.glassSource,
                        item.polishSupplier, item.chromeSupplier, item.glueSupplier, item.recycleStatus,
                        item.reprocessPlan, item.recycleBatch, item.factory
                    ]);
                    
                    // 创建工作簿和工作表
                    const ws = XLSX.utils.aoa_to_sheet([headers, ...dataRows]);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, '回收报表数据');
                    
                    // 导出为XLSX文件
                    XLSX.writeFile(wb, `回收版使用统计报表_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.xlsx`);
                },
                
                convertToCSV(data) {
                    const headers = [
                        '客户名称', '流程单号', 'Model号', '制作设备', 'CD', '图层',
                        '锁单时间', '主材批号', '主材供应商', '订单类型', '尺寸',
                        '黑缺陷', '白缺陷', '修补时间/h', '判定类别', '玻璃来源',
                        '抛光厂家', '镀铬厂家', '涂胶厂家', '回收情况', '再处理方案',
                        '回收批次', '厂别'
                    ];
                    
                    const csvRows = [headers.join(',')];
                    
                    data.forEach(item => {
                        const values = [
                            item.customer, item.processNumber, item.model, item.equipment, item.cd, item.layer,
                            item.lockTime, item.batchNumber, item.supplier, item.orderType, item.size,
                            item.blackDefect, item.whiteDefect, item.repairTime, item.judgeType, item.glassSource,
                            item.polishSupplier, item.chromeSupplier, item.glueSupplier, item.recycleStatus,
                            item.reprocessPlan, item.recycleBatch, item.factory
                        ];
                        csvRows.push(values.map(v => `"${v}"`).join(','));
                    });
                    
                    return csvRows.join('\n');
                }
            },
            
            mounted() {
                // 页面加载时不自动查询数据，仅在点击查询按钮时触发
            }
        }).mount('#app');
    </script>
</body>
</html>